# Controls when the workflow will run
on: # 이럴때 실행 해달라
  push: # push를 할때
    branches: #어떤것이?
      - main # main이
   # main의 정보에 push될때마다 실행을 해달라

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.5.3
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Deploy to EC2
        env:  # 환경 변수 설정
          PORT: ${{ secrets.PORT }}
          MONGO_DB_URL: ${{ secrets.MONGO_DB_URL }}
          MONGO_DB_COLLECTION: ${{ secrets.MONGO_DB_COLLECTION }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          GOOGLE_OAUTH_SIGNIN_REDIRECT_URL: ${{ secrets.GOOGLE_OAUTH_SIGNIN_REDIRECT_URL }}
          GOOGLE_OAUTH_SIGNUP_REDIRECT_URL: ${{ secrets.GOOGLE_OAUTH_SIGNUP_REDIRECT_URL }}
          NODEMAILER_AUTH_EMAIL: ${{ secrets.NODEMAILER_AUTH_EMAIL }}
          NODEMAILER_AUTH_PASS: ${{ secrets.NODEMAILER_AUTH_PASS }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          FRONT_END_POINT: ${{ secrets.FRONT_END_POINT }}
          BASE_URL: ${{ secrets.BASE_URL }}
        run: |
          ssh -o StrictHostKeyChecking=no ec2-user@13.209.89.34 "
            export PORT=$PORT &&
            export MONGO_DB_URL=$MONGO_DB_URL &&
            export MONGO_DB_COLLECTION=$MONGO_DB_COLLECTION &&
            export GOOGLE_API_KEY=$GOOGLE_API_KEY &&
            export GOOGLE_CLIENT_ID=$GOOGLE_CLIENT_ID &&
            export GOOGLE_CLIENT_SECRET=$GOOGLE_CLIENT_SECRET &&
            export GOOGLE_OAUTH_SIGNIN_REDIRECT_URL=$GOOGLE_OAUTH_SIGNIN_REDIRECT_URL &&
            export GOOGLE_OAUTH_SIGNUP_REDIRECT_URL=$GOOGLE_OAUTH_SIGNUP_REDIRECT_URL &&
            export NODEMAILER_AUTH_EMAIL=$NODEMAILER_AUTH_EMAIL &&
            export NODEMAILER_AUTH_PASS=$NODEMAILER_AUTH_PASS &&
            export JWT_SECRET_KEY=$JWT_SECRET_KEY &&
            export FRONT_END_POINT=$FRONT_END_POINT &&
            export BASE_URL=$BASE_URL &&
            cd /home/ec2-user/workplus-back &&
            npm install &&
            pm2 restart index.js || pm2 start index.js --name workplus-back"
